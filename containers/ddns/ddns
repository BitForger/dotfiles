#!/bin/zsh

if [[ -z "$DOMAIN" ]]; then
  echo "Error: DOMAIN environment variable is not set. Please set it to your domain name (e.g., example.com)."
  exit 1
fi

if [[ -z "$DO_TOKEN" ]]; then
  echo "Error: DO_TOKEN environment variable is not set."
  exit 1
fi

# Check if RECORD_ID is set
# This should be the ID of the DNS record you want to update (e.g., the A record for your domain).
# You can find this ID by listing your DNS records via the DigitalOcean API
# or doctl compute domain records list <domain>
if [[ -z "$RECORD_ID" ]]; then
  echo "Error: RECORD_ID environment variable is not set. Please set it to the ID of your DNS record."
  exit 1
fi

echo "Getting current public IP address..."
# Get current public IP from UniFi controller
CURRENT_IP=$(curl -s "https://api.ipify.org")

echo "Current public IP: $CURRENT_IP"
sleep 1

echo "Getting current DNS record from DigitalOcean..."
# Get current DNS record from DO
DO_IP=$(curl -s -H "Authorization: Bearer ${DO_TOKEN}" \
  "https://api.digitalocean.com/v2/domains/$DOMAIN/records/$RECORD_ID" | jq -r '.domain_record.data')

echo "Current DNS record IP: $DO_IP"

echo "Checking if update is needed..."
# Update if IP changed
if [[ "$CURRENT_IP" != "$DO_IP" ]]; then
  echo "IP has changed. Updating DNS record..."
  curl -X PUT \
    -H "Authorization: Bearer ${DO_TOKEN}" \
    -H "Content-Type: application/json" \
    -d "{\"data\":\"$CURRENT_IP\", \"ttl\":3600}" \
    "https://api.digitalocean.com/v2/domains/$DOMAIN/records/$RECORD_ID"
fi